generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProjectType {
  MOD
  MODPACK
  RESOURCEPACK
  SHADER
  PLUGIN
  DATAPACK
}

enum TagType {
  LOADER
  CATEGORY
  GAME_VERSION
  CUSTOM
}

model User {
  id              Int       @id @default(autoincrement())
  username        String    @unique @db.VarChar(50)
  email           String    @unique @db.VarChar(255)
  hashedPassword  String    @map("hashed_password") @db.VarChar(255)
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  
  modpacks              Modpack[]
  oauthClients          OAuthClient[]
  accessTokens          AccessToken[]
  refreshTokens         RefreshToken[]
  authorizationCodes    AuthorizationCode[]
  personalAccessTokens  PersonalAccessToken[]

  @@index([username])
  @@index([email])
  @@map("users")
}

model Modpack {
  id                Int         @id @default(autoincrement())
  name              String      @db.VarChar(255)
  slug              String      @unique @db.VarChar(255)
  description       String?     @db.Text
  projectType       ProjectType @default(MODPACK) @map("project_type")
  mcVersion         String      @map("mc_version") @db.VarChar(20)
  loader            String      @db.VarChar(20)
  loaderVersion     String?     @map("loader_version") @db.VarChar(50)
  recommendedRamGb  Int         @default(4) @map("recommended_ram_gb")
  downloads         Int         @default(0)
  authorId          Int         @map("author_id")
  isPublished       Boolean     @default(false) @map("is_published")
  licenseId         String?     @map("license_id") @db.VarChar(100)
  licenseUrl        String?     @map("license_url") @db.VarChar(512)
  createdAt         DateTime    @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt         DateTime    @updatedAt @map("updated_at") @db.Timestamptz()
  
  author            User      @relation(fields: [authorId], references: [id])
  versions          ModpackVersion[]
  tags              ProjectTag[]

  @@index([name])
  @@index([slug])
  @@index([mcVersion])
  @@index([loader])
  @@index([authorId])
  @@index([projectType])
  @@index([licenseId])
  @@map("modpacks")
}

model ModpackVersion {
  id              Int       @id @default(autoincrement())
  modpackId       Int       @map("modpack_id")
  version         String    @db.VarChar(50)
  mcVersion       String    @map("mc_version") @db.VarChar(20)
  loader          String    @db.VarChar(20)
  loaderVersion   String?   @map("loader_version") @db.VarChar(50)
  changelog       String?   @db.Text
  downloadUrl     String?   @map("download_url") @db.VarChar(512)
  fileSize        Int?      @map("file_size")
  downloads       Int       @default(0)
  isStable        Boolean   @default(true) @map("is_stable")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  
  modpack         Modpack   @relation(fields: [modpackId], references: [id], onDelete: Cascade)

  @@index([modpackId])
  @@map("modpack_versions")
}

model Tag {
  id        Int          @id @default(autoincrement())
  name      String       @unique @db.VarChar(100)
  slug      String       @unique @db.VarChar(100)
  type      TagType
  color     String?      @db.VarChar(7)
  icon      String?      @db.VarChar(255)
  createdAt DateTime     @default(now()) @map("created_at") @db.Timestamptz()
  
  projects  ProjectTag[]

  @@index([type])
  @@index([slug])
  @@map("tags")
}

model ProjectTag {
  projectId Int      @map("project_id")
  tagId     Int      @map("tag_id")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()
  
  project   Modpack  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([projectId, tagId])
  @@index([projectId])
  @@index([tagId])
  @@map("project_tags")
}

model OAuthClient {
  id            String   @id @default(cuid())
  clientId      String   @unique @map("client_id") @db.VarChar(255)
  clientSecret  String   @map("client_secret") @db.VarChar(255)
  name          String   @db.VarChar(255)
  description   String?  @db.Text
  redirectUris  String[] @map("redirect_uris")
  scopes        String[]
  userId        Int      @map("user_id")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz()
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessTokens  AccessToken[]

  @@index([clientId])
  @@index([userId])
  @@map("oauth_clients")
}

model AccessToken {
  id            String    @id @default(cuid())
  token         String    @unique @db.VarChar(512)
  userId        Int       @map("user_id")
  clientId      String?   @map("client_id")
  scopes        String[]
  expiresAt     DateTime  @map("expires_at") @db.Timestamptz()
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  client        OAuthClient? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([clientId])
  @@map("access_tokens")
}

model RefreshToken {
  id            String    @id @default(cuid())
  token         String    @unique @db.VarChar(512)
  userId        Int       @map("user_id")
  clientId      String?   @map("client_id")
  scopes        String[]
  expiresAt     DateTime  @map("expires_at") @db.Timestamptz()
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("refresh_tokens")
}

model AuthorizationCode {
  id            String    @id @default(cuid())
  code          String    @unique @db.VarChar(255)
  userId        Int       @map("user_id")
  clientId      String    @map("client_id")
  redirectUri   String    @map("redirect_uri") @db.VarChar(512)
  scopes        String[]
  expiresAt     DateTime  @map("expires_at") @db.Timestamptz()
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([userId])
  @@map("authorization_codes")
}

model PersonalAccessToken {
  id            String    @id @default(cuid())
  name          String    @db.VarChar(255)
  token         String    @unique @db.VarChar(512)
  tokenPrefix   String    @map("token_prefix") @db.VarChar(20)
  userId        Int       @map("user_id")
  scopes        String[]
  lastUsedAt    DateTime? @map("last_used_at") @db.Timestamptz()
  expiresAt     DateTime? @map("expires_at") @db.Timestamptz()
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([tokenPrefix])
  @@index([userId])
  @@map("personal_access_tokens")
}
